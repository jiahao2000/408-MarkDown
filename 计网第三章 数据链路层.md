# 计算机网络
## 数据链路层
### 考纲
+ 数据链路层的功能
+ 组帧
+ 差错控制
  + 检错编码，纠错编码
+ 流量控制与可靠传输机制
  + 流量控制、可靠传输与滑动窗口机制
  + 停止-等待协议
  + 后退N帧协议(GBN)
  + 选择重传协议(SR)
+ 介质访问控制
  + 信道划分
    + 频分多路复用
    + 时分多路复用
    + 波分多路复用
    + 码分多路复用
  + 随机访问
    + ALOHA协议
    + CSMA协议
    + CSMA/CD协议
    + CSMA/CA协议
  + 令牌传递协议
+ 局域网
  + 局域网基本概念与体系结构
  + 以太网与IEEE802.3
  + IEEE802.11 无线局域网
  + VLAN基本概念与基本原理
+ 广域网
  + 广域网的基本概念
  + PPP协议
+ 数据链路层设备
  + 局域网交换机及其工作原理


***
### 3.1 数据链路层的功能
#### 为网络提供服务
+ 无确认无连接
+ 有确认无连接
+ 有确认面向连接
  注意：有连接就一定要有确认

#### 链路管理
数据链路层连接的建立、维持和释放过程称为链路管理

#### 帧定界、帧同步与透明传输
透明传输是指不管所传数据时什么样的比特组合，都应当能在链路上传送

#### 流量控制
流量控制实际上是限制发送方的数据流量，使其发送速率不超过接收方的接收能力。
流量控制不是数据链路层特有的功能，许多高层协议也提供此功能，但是控制的对象不同。数据链路层控制的是相邻两节点之间数据链路上的流量，而对于运输层来说，控制的则是从源端到目的端之间的流量。

#### 差错控制
用以使发送发确定接收方是否正确接收到由其发送的数据的方法称为差错控制。通常，这些错误可以分为位错和帧错。
位错通常用循环冗余校验(CRC)的方式发现，通过自动重传请求(ARQ)方式来重传出错的帧。
帧错指帧的丢失、重复或失序等错误。在数据链路层引入**定时器和编号机制**，能保证每一帧最终都能有且仅有一次正确地交付给目的结点。

***
### 3.1习题
#### 3、
为避免传输过程中帧地丢失，数据链路层采用的方法是计时器超时重发。
为了保证不会接收到重复帧，需要对每个帧进行编号。
汉明码和循环冗余校验码都用于差错控制。

#### 7、
ICMP(网际控制报文协议)是网络层协议。PPP是在SLIP基础上发展而来，都是数据链路层协议。

***

### 3.2 组帧
组帧主要解决帧定界、帧同步、透明传输等问题。
组帧时既要加首部又要加尾部。
|组帧方法 | 具体使用 | 特点 |
| --- | --- | --- |
| 字符计数法 | 在帧头部使用一个计数字段来标明帧内字符数 | 字符计数法包括计数字段。如果计数字段出错，接收端就无法判断帧的结束位和下一帧的开始位，收发双方将失去同步 | 
| 字符填充的首尾定界符法 | 使用特殊字符来定界一帧的开始和结束 | 为防止信息位中的特殊字符被误判为定界符，可在特殊字符前面填充一个转移字符(ESC)来加以区分 |
| 零比特填充的首位标志法 | 使用01111110来标志一帧的开始和结束 | 为防止信息位中的01111110被误判为首尾标志，信息位中每遇到连续的5个1，就在其后插入一个0。<br>接收方则做该过程的逆操作 |
| 违规编码法 | 使用违规编码序列来定界帧的起始和终止 | 通常在物理层编码使用，如曼彻斯特编码中的低-低 和 高-高电平就是违规的，局域网IEEE802标准就采用了这种方法 |

目前常用的方法是**比特填充法**和**违规编码法**

***
### 3.3差错控制
通常利用编码技术进行差错控制，主要有两类：自动重传请求ARQ和前向纠错FEC。ARQ中，接收端检测到错误时，就设法通知发送端重发，直到接收到正确的码字为止。在FEC方式中，接收端不但可以发现差错，还能确定比特串的错误位置，从而加以纠正。因此，差错控制又可分为检错编码和纠错编码。
#### 检错编码
+ 奇偶校验码
  + 奇校验：添加以为0或1使得总体有奇数个1
+ 循环冗余码(CRC)CRC实际上也有纠错功能，但数据链路层仅使用了它的检错功能。
  
#### 纠错编码
+ 海明码
编码原理和过程：
  1. 确定海明码的位数：n位信息位，k位校验位，满足$n+k\leqslant2^k-1$(若需要检两位错，则需要再增加1位校验位，即k+1位)
  2. 确定校验位的分布，规定校验位$P_i$在海明位号为$2^{i-1}$的位置上。
  3. 分组以形成校验关系
  4. 校验位取值
  5. 海明码的校验原理

***
### 3.3习题
#### 5、
海明码的码距：
检验n位错误 码距n+1位
纠正n位错误 码距2n+1位

#### 7、
带r个校验位的多项式编码可以检测到所有长度小于等于r的突发性错误。
CRC校验可以使用硬件来完成

***
### 3.4流量控制与可靠传输机制
#### 流量控制、可靠传输与滑动窗口机制
+ 停止-等待流量控制基本原理
+ 滑动窗口流量控制基本原理
+ 可靠传输机制
  + 通常使用确认和超时重传机制实现

#### 单帧滑动窗口与停止-等待协议
#### 多帧滑动窗口与后退N帧协议(GBN)
GBN采用累积确认方式
若采用n比特对帧编号，发送窗口的尺寸$W_T$应该满足$ 1\le W_T\le2^n-1$
#### 多帧滑动窗口与选择重传协议(SR)
若采用n比特对帧编号，则需要满足$W_{Tmax} = W_{Rmax} =2^{n-1}$

对于任何一个滑动窗口来说，采用n比特对帧编号，都需要满足$W_T + W_R\le2^n$

### 3.4习题
#### 8、
$发送窗口大小\le窗口总数-1$

#### 10、
发送窗口的上边界对应的帧序号为U,使用n比特对帧编号，发送窗口大小为W,那么发送窗口的下边界对应的帧序号为$\ge(U-W+1)mod2^k$

#### 13、
后退N帧协议计算信道利用率时，计算发送周期**只需要计算第一个帧发送的时间**，因为其他帧在发送时，第一个帧已经在等待发送方的确认帧了


***

### 3.5 介质访问控制
介质访问控制所要完成的主要任务是，为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动结点的传输。
用来决定广播信道中信道分配的协议属于数据链路层的一个子层，称为介质访问控制(Medium Access Control, MAC)子层。
+ 静态划分
  + 信道划分介质访问控制
+ 动态划分
  + 随机访问介质访问控制
  + 轮询访问介质访问控制
  
#### 信道划分介质访问控制
信道划分介质访问控制将使用介质的每个设备与来自同一通信信道上的其他设备的通信隔离开来，把时域和频域资源合理地分配给网络上的设备。
多路复用技术把多个信号组合在一条物理信道上进行传输，使多个计算机或终端设备共享信道资源，提高了信道的利用率。
多路复用器可以把多个信号组合在一个无用通道中，在接收端把收到的信息分离出来并传送到对应的输出通道。

##### 1. 频分多路复用(FDM)
将多路信号调制到不同频率载波上，再叠加形成一个复合信号。
每个信道子信道分配的带宽可以不同，但他们的和不能超过信道的总带宽。在实际应用中，为了防止子信道之间的干扰，相邻信道之间需要加入“保护频带”。
优点：充分利用了传输介质的带宽，系统效率较高。

##### 2. 时分多路复用(TDM)
将一条物理信道按时间划分为若干个时间片，轮流的分配给多个信号使用。每个时间片由复用的一个信号占用。
统计时分多路复用(STDM，又称*异步时分多路复用*)使TDM的一种改进，他并不固定的分配时隙，而是按需动态的分配时隙，当终端由数据要发送时，才会分配到时间片，因此可以提高线路的利用率。

##### 3. 波分多路复用(WDM)
即光的频分多路复用

##### 4. 码分多路复用
原理：将每个比特时间在划分成m个短的时间槽，称为码片(Clip)，通常m的值使64或128，每个站点被指派一个唯一的码片序列。发送1时，站点发送它的码片序列；发送0时，站点发送该码片序列的反码。当两个或多个站点同时发送时，各路数据在信道中线性相加。为从信道中分离出各路信号，要求各个站点的码片序列相互正交。
任何一个码片向量自身的规格化内积都是1，任何一个码片向量和该码片发麻的向量的规格化内积是-1，任何一个码片和其他信源的码片的规格化内积为0。

码分多路复用技术具有频谱利用率高、抗干扰能力强、保密性强、语音质量好等优点，还可以减少投资和降低运行成本，主要用于无线通信系统，特别是移动通信系统。

#### 随机访问介质访问控制
##### 1.ALOHA协议
###### (1) 纯ALOHA协议
  直接发，若超时未收到确认，则再次发送，直到发送成功。
  纯ALOHA协议采用的重传策略是让各站等待一段随机的时间。

###### (2) 时隙ALOHA协议
  把所有各站在时 间上同步起来，并将时间划分为一段段登场的时隙，规定只能在每个时隙开始时才能发送一个帧。时隙的长度$T_0$使得每个帧正好在一个时隙内发送完毕。
  时隙ALOHA协议比纯ALOHA协议的吞吐量大了一倍。

##### 2. CSMA协议
载波侦听多路访问(Carrier Sense Multiple Access, CSMA)协议时在ALOHA协议的基础上提出的一种改进协议。它多了一个载波侦听装置。

###### 1-坚持CSMA
先侦听，如果信道空闲，立刻发；如果信道忙，则继续侦听直到信道空闲，如果发生冲突，则随机等待一段时间，再重新开始侦听信道。
缺点：传播延迟对1-坚持CSMA协议的性能影响较大，如果由多个结点在等待信道空闲，则信道空闲时这多个结点会同时发送数据，导致出现冲突。

###### 非坚持CSMA
在侦听到信道忙时则会放弃侦听，等待一个随机时间后在进行侦听

###### p-坚持CSMA
监听信道，如果忙，则持续侦听(p-坚持CSMA适用于时隙信道，此处持续侦听就是推迟到下一个时隙再侦听)，直到信道空闲，如果信道空闲，那么以概率p发送数据，以概率1-p推迟到下一个时隙，如果下一个时隙信道仍然空闲，重复上述，这个剁成一直持续到数据发送成功或因其他结点发送数据而导致信道忙为止，如果是后者，则等待到下一个时隙再重新开始侦听。
| 信道状态 | 1-坚持 | 非坚持 | p-坚持 |
| --- | --- | --- | --- |
| 空闲 | 立刻发送数据 | 立刻发送数据 | p概率发送数据，1-p概率推迟到下一个时隙 |
| 忙 | 坚持侦听 | 放弃侦听，等待一个随机的时间后再侦听 | 持续侦听，直至信道空闲 |

##### 3. CSMA/CD协议
载波侦听多路访问/碰撞检测(Carrier Sense Multiple Access with Collision Detection)协议是CSMA协议的改进方案，适用于总线形网络或半双工网络环境。
先听后发 边听边发 冲突停发 随机重发
站点再发送帧后至多$2\tau$(端到端传播时延的2倍)就能知道所发的帧有没有发生碰撞，因此把一台网端到端往返时间$2\tau$称为争用期(也叫争议期、冲突窗口或碰撞窗口)
为了却把发送站在发送数据的同时能检测到可能存在的碰撞，需要在发送完帧之前就能收到自己发送出去的数据，即帧的传输时延至少要两倍于信号在总线中的传播时延，所以CSMA\CD总线网中所有数据帧都必须要大于一个最小帧长，任何站点收到帧长小于最小帧长的帧时，就把它当作无效帧丢弃。最小帧长的计算公式为：
$$
  最小帧长 = 总线传播时延*数据传输速率*2
$$
CSMA/CD处理冲突采用**二进制指数退避算法**
1. 确定基本退避时间，一般取两倍的端到端传输时延
2. 定义参数k，它等于重传次数，$k=min\{重传次数，10\}$
3. 从$[0,2^k-1]$中随机取一个数r，重传所需要退避的时间为r倍的基本退避时间
4. 如果**重传16次仍不能成功**，说明网络太拥挤，认为此帧永远无法正确发出，抛弃此帧并向高层报告出错。

##### 4. CSMA/CA协议
CSMA/CD协议不适用于无线局域网的碰撞检测，原因有两点：
1. 接收信号强度小，且在无线介质上信号强度的动态变化范围很大，因此要实现碰撞检测，则硬件上的花费就会过大。
2. 在无线通信中，并非所有的站点都能听见对方，即存在“隐蔽站”的问题。
   
为此，802.11标准定义了应用于无线局域网的CSMA/CA协议，将碰撞检测改为了碰撞避免(Collision Avoidance,CA)。碰撞避免并不是指协议可以完全避免碰撞，而是指协议的涉及要尽量减低碰撞发生的概率。
由于无线信道的通信质量远不如优先信道，802.11使用链路层确认/重传(ARQ)方案，即站点每通过无线局域网发送完一帧，就要在收到对方的确认帧后才能继续发送下一帧。

为了尽量避免碰撞，802.11规定，所有站完成发送后，必须再等待一段时间(继续监听)才能发送下一帧，这段时间称为帧间间隔(InterFrame Space, IFS)。
802.11使用了三种IFS:
1. SIFS(短IFS)：最短的IFS,用于分隔属于一次对话的各帧，使用SIFS的帧类型有ACK帧，CTS帧、分片后的数据帧，以及所有回答AP探询的帧等。
2. PIFS(点协调IFS): 中等长度的IFS，再PCF操作中使用。
3. DIFS(分布式协调IFS)： 最长的IFS，用于异步帧竞争访问的时延。
  
CSMA/CA的退避算法
当且仅当检测到信道空闲且这个数据帧是要发送的第一个帧时，才不使用退避算法。其他所有情况都必须使用退避算法，具体为：
1. 在发送第一个帧之前检测到信道忙
2. 每次重传
3. 每次成功发送后要发送下一帧
   
CSMA/CA算法归纳如下
1. 若站点最初有数据要发送，且检测到信道空闲，在等待时间DIFS后，就发送整个数据帧。
2. 否则，站点执行退避算法，选取一个随机回退值。一旦检测到信道忙，退避计数器就保持不变。只要信道空闲，退避计时器就能进行倒计时。
3. 当退避计时器减到0时，站点就发送整个帧并等待确认。
4. 发送站若收到确认，就知道已发送的帧被目的站正确的接收。这是如果要发送第二个帧，就要从步骤2开始。如果没有收到确认帧ACK,就必须重传该帧，再次使用CSMA/CA协议征用该信道，直到收到确认，或经过若干次重传失败后放弃发送。

处理隐蔽站问题：RTS和CTS
站A和B都在AP的覆盖范围内，但A和B相距较远，彼此听不见对方，当A和B检测到信道空闲时，都向AP发送数据，导致碰撞的发生，这就是隐蔽站问题。
为了避免该问题，802.11允许发送站对信道进行预约。源站要发送数据帧之前先广播一个很短的请求发送RTS控制帧，它包括源地址、目的地址和这次通信(含相应的确认帧)所持续的时间，该帧能被其范围内包括AP在内的所有站点听到。若信道空闲，则AP广播一个允许发送CTS(Clear To Send)空指针，它包括这次通信所需的持续时间(从RTS帧复制)。其他站点听到后，将在CTS帧指明的时间内抑制发送。
CTS帧有两个目的：给源站明确的发送许可，指示其他站点在预约期间不要发送。
各站可以自行决定是否使用信道预约，只有当数据帧的长度大于某一数值时，使用RTS和CTS帧比较有利。

CSMA/CD 和CSMA/CA的区别
1. CD可以检测冲突，CA不能，只能尽量避免冲突。
2. 传输介质不同，CD用于总线形以太网，CA用于无线局域网802.11a/b/g/n等
3. 检测方式不同，CD通过电缆中电压的变化来检测，而CA采用能量检测、载波检测、和能量载波混合检测三种方式。
   
#### 轮询访问：令牌传递协议
令牌环网中令牌和数据的传递过程如下：
1. 网络空闲时，环路中只有令牌帧在循环传递
2. 令牌传递到有数要发送的站点时，该站点会修改令牌的一个标志位，并在令牌中附加要传的数据，将令牌变成一个数据帧并发送出去。
3. 数据帧沿环路传输，接收到的站点一边转发数据，一边查看帧的目的地址。如果接收方是自己，那么接收站就复制该帧以便进一步处理。
4. 数据帧继续传输，直到到达该帧的源站点，源站点收到后不在转发。通过检验返回的帧来查看传输是否出错，若出错，则重发。
5. 源站点传送完数据后，重现产生一个令牌，并传递给下一个站点，以交出信道控制权。
  
站点在获得令牌后只能使用一定的时间，不能一直使用下去。
轮询介质访问不会出现冲突，适用于负载很高的广播信道，既不共享时间也不共享空间，它是限制了有权利发送数据的结点只能有一个。

### 3.5习题

#### 9、
争用期 争议期

#### 10、
最短帧长度

#### 15、
令牌环网适用于负载很高的网络

#### 17、
多路复用器的作用是结合来自两条或更多条线路的传输

#### 21、
码分多址中各发送站点的码片序列必须正交

#### 23、
对正确接收的数据帧进行确认的MAC协议是CSMA/CA

#### 25、
码分多址中，根据收到的序列和发送点的码片序列求出发送的数据

#### 26、
当信号的传播时延趋近于零时，信道利用率趋近100%

#### 28、
CSMA/CA的信道预约方法为：RTS帧和CTS帧

#### 30、
两次数据传输之间的间隔是最长的，称为DIFS，用于异步帧竞争访问的时延。