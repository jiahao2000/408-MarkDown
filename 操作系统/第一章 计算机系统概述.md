# 计算机系统概述

## 考纲内容
1. 操作系统的基本概念
1. 操作系统的发展历程
1. 程序运行环境
    1. CPU运行模式：内核态与用户态
    1. 中断和异常的处理：系统调用
    1. 程序的链接与装入：程序运行时的内存映像与地址空间
1. 操作系统结构
    1. 分层、模块化、宏内核、微内核、外核
1. 操作系统引导
1. 虚拟机

## 1.1操作系统的基本概念
### 定义
操作系统是指控制和管理整个计算机系统的硬件和软件资源，合理地组织、调度计算机地工作与资源分配，进而为用户和其他软件提供方便地接口与环境的程序集合。
操作系统是计算机系统中最基本的系统软件。
1. 操作系统是系统资源的管理者。
1. 向上层提供方便易用的服务
1. 最接近硬件的一层软件

系统资源地管理者：
1. 处理机管理
1. 存储器管理
1. 文件管理
1. 设备管理

操作系统对上层提供的接口
1. GUI
1. 联机命令接口=交互式命令接口 ：用户说一句，系统做一句
1. 脱机命令接口=批处理命令接口 ：一次性发出多条命令，如windows批处理文件
1. 程序接口：可以在程序中进行**系统调用**来使用程序接口。普通用户不能直接使用程序接口，只能通过程序代码简介使用。如C语言中的printf命令

通常把覆盖了软件的机器称为扩充机器，又称之为虚拟机。

操作系统对硬件机器的扩展：将CPU、内存、磁盘、显示器、键盘等硬件合理地组织起来，让各种硬件能够相互协调配合，实现更多更复杂地功能

### 操作系统的特征
1. 并发：宏观上是同时发生地，但微观上是交替发生的。（并行：是指两个或多个事件在同一时刻同时发生）。
    操作系统的并发性指计算机系统中同时运行着多个程序，这些程序宏观上是同时运行的，而微观上是交替运行的。
    **单核CPU**同一时刻只能执行一个程序，各个程序只能**并发**地执行。
    **多核CPU**同一时刻可以同时执行多个程序，多个程序可以**并行**地执行。
1. 共享
    共享：即资源共享
    1. 互斥共享方式：一个时间段内只允许一个进程访问该资源
    1. 同时共享方式：允许一个时间段内由多个进程“同时”对他们进行访问（同时往往是指宏观上的同时，也有可能是微观上的同时：如扬声器同时播放两个进程的声音）
1. 虚拟
    指把一个物理上的实体变为若干个逻辑上的对应物。物理实体（前者）是实际存在的，而逻辑上对应物（后者）是用户感受到的。
    虚拟内存（空分复用技术）、虚拟处理器技术（时分复用技术）
    如果失去了并发性，同一时间内只有一个程序，那么虚拟性就没有存在的必要
1. 异步
    指在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程并不是一贯到底的，而是走走停停，以不可预知的速度向前推进，这就是进程的异步性。
    只有系统拥有并发性，才有可能导致异步性

其中**并发和共享为最基本的特征**，并且二者互为存在条件。如果失去并发性，系统中只有一个程序正在运行，则共享性失去存在的意义。如果失去共享性，则QQ和微信不能同时访问硬盘资源，就无法实现同时发送文件，也就无法并发。

## 1.2操作系统发展历程

### 手工操作阶段（此阶段无操作系统）
1. 用户独占全机，资源利用率低
1. CPU等待手工操作，CPU利用不充分

### 批处理阶段（操作系统开始出现）
1. 单道批处理系统
    引入脱机输入/输出技术，并由监督程序负责控制作业的输入输出
    1. 自动行
    1. 顺序性
    1. 单道性
1. 多道批处理系统
    操作系统正式诞生，每次往内存中读入多道程序，**引入了中断技术**
    优点：多道程序并发执行，共享计算机资源。资源利用率大幅提升，系统吞吐量增大
    缺点：没有人机交互功能
### 分时操作系统
计算机以时间片为单位，轮流为各个用户/作业服务，各个用户可通过终端与计算机及逆行交互。
优点：用户请求可以被即时响应，解决了人机交互问题。各个用户对计算机的操作相互独立，感受不到别人的存在。
缺点：不能优先处理一些紧急任务，对各个用户是完全公平的，不区分任务的紧急性。
### 实时操作系统
优点：能够优先响应一些紧急任务，某些紧急任务不需要时间片排队。
硬实时操作系统：必须在绝对严格的规定时间内完成处理：如导弹控制系统、自动驾驶系统
软实时操作系统：能够接收偶尔违反时间规定：如12306火车订票系统


---
### 其他操作系统
1. 网络操作系统
1. 分布式操作系统
1. 个人计算机操作系统


## 1.3 操作系统运行环境

### 处理器运行模式
两类程序
1. 内核程序
1. 应用程序

两类指令
1. 特权指令
    指不允许用户直接使用的指令，如I/O的指令、置中断指令，存取用于内存保护的寄存器、送程序状态字到PSW等指令。
1. 非特权指令

两种处理器状态
1. 内核态/核心态/管态
1. 用户态/目态

内核态→用户态：一条修改PSW的特权指令
用户态→内核态：由中断引起，硬件自动完成

### 中断和异常
CPU上会运行两种程序，一种是操作系统内核程序（是整个系统的管理者），一种是应用程序
中断的作用：中断是让操作系统内核夺回CPU使用权的唯一途径。如果没有中断机制，就无法实现操作系统的并发性。

#### 中断的类型
+ 内中断（也称异常、例外）
    + 软件中断
        + 陷阱、陷入、自陷(trap)：由陷入指令引发，是应用程序故意引发的
        + 故障（fault)：由错误条件引起的，可能被内核程序修复的问题：如缺页故障
    + 硬件中断
        + 终止（Abort）：由致命错误引起，内核程序无法修复该错误，因此一般不再将CPU使用权还给引发终止的程序。如整数除以0、非法使用特权指令。
+ 外中断：与当前执行的指令无关，中断信号来源于CPU外部
    + 可屏蔽中断 INTR
    + 不可屏蔽中断 NMI

大多数教材、试卷中，中断是指狭义的中断，即外中断。而内中断一般称为异常。

#### 系统调用
系统调用是比高级语言的库函数更为底层的接口。但不是所有的库函数功能都需要进行系统调用。
过程：
传递系统调用的参数→执行陷入指令（trap）→执行相应的内核程序处理系统调用（核心态）→返回应用程序

### 操作系统体系结构
操作系统的分层
1. 非内核功能
1. 进程管理、存储器管理、设备管理等功能
1. 时钟管理 中断处理 原语 

内核时操作系统最核心最基本的部分，实现操作系统内核功能的就是内核程序

+ 宏内核，也叫大内核或单内核，将2、3都放入内核中的结构就是宏内核 如Linux、UNIX
    优点：高性能
    缺点：内核代码庞大、结构混乱、难以维护
+ 微内核，只将与硬件关系最紧密的3放入内核 如 windows
    优点：内核功能少、结构清晰、方便维护
    缺点：需要频繁地在核心态和用户态之间切换，性能低

CPU的状态转换是由成本的，要消耗不少的时间，频繁的改变状态会消耗大量时间

| | 特性、思想 | 优点 | 缺点 | 
| --- | --- | --- | --- | 
| 分层结构 | 最底层是硬件，最高层是用户接口，内核分多层，每层可单向调用更低一层提供的接口 | 1.便于调试和验证 <br>2.易于扩充和维护，各层之间调用接口清晰固定 | 1.仅可调用相邻的低层，难以合理定义各层的边界 <br> 2.效率低，不可跨层调用，系统调用执行时间长 |
| 模块化 | 将内核划分为多个模块，各个模块之间相互协作 <br>内核 = 主模块(进程，内存) + 可加载内核模块（驱动程序2）<br>主模块：只负责核心功能，如进程调度、内存管理<br>可加载内核模块：可以动态的加载新模块到内核，而无需重新编译整个内核 | 1.模块间逻辑清晰易于维护，确定模块间接口之后即可多模块同时开发<br>**2**.支持动态加载新的内核模块(如：安装设备驱动程序、安装新的文件系统模块到内核)，增强OS适应性 <br>**3**.任何模块都可以直接调用其他模块，无需采用消息传递进行通信，效率高 | 1.模块间的接口定义未必合理、实用<br>2.模块间相互依赖，更难调试和验证 |
| 宏内核 | 把所有的系统功能都放在了内核中 | 性能高，内核内部各种功能都可以直接相互调用 | 1.内核庞大功能复杂，难以维护<br>2.大内核中某个功能模块出错，就可能导致整个系统崩溃 |
| 微内核 | 只把中断、原语、进程通信等最核心的功能放入内核。进程管理、文件管理、设备管理等功能以用户进程的形态运行在用户态 | 1.内核小功能少，易于维护，内核可靠性高 <br> 2.内核外的某个功能出错不会导致整个系统崩溃 | 1.性能低，需要频繁的切换用户态/核心态。<br>2.用户态下的个功能模块不可以直接相互调用，只能通过内核的“消息传递”来间接通信
| 外核（exokernel） | 内核负责进程调度、进程通信等功能，外核负责为用户进程分配未经抽象(正常的内存空间是虚拟化的地址空间，即抽象化的;文件的各个块在磁盘中可能是分散的，会导致用户进程对文件的随机访问能力降低。而外核可以给用户进程分配连续的磁盘块，使读取外存的速度加快)的硬件资源，且由外核保证硬件资源的使用安全 | 1.外核可直接给用户分配“不虚拟，不抽象”的硬件资源，使用户进程可以更灵活的使用硬件资源<br>2.减少了虚拟意见资源的“一致性”，提升效率 | 1.降低了系统的一致性 <br>2.使系统变得更复杂｜

### 操作系统引导

开机时，怎样让操作系统运行起来
计算机的主存由RAM和ROM组成
ROM中存储着BIOS,包含ROM引导程序，即自举程序，ROM中的数据不会因为断电丢失。
磁盘：
| 主引导记录(MBR)包含磁盘引导程序和分区表 | C:盘 | D:盘 |
| --- | --- | --- |
C:盘中：
| 引导记录PBR，负责找到启动管理器 | 根目录(包含启动管理程序) | 其他 |
| --- | --- | --- |


1. CPU从一个特定的主存地址开始，取指令，执行ROM中的引导程序(先进行硬件自检，再开机)
1. 将磁盘的第一块——主引导记录读入内存，执行磁盘引导程序，扫描分区表
1. 从活动分区(又称主分区，即安装了操作系统的分区)读入分区引导记录，执行其中的程序
1. 从根目录下找到完整的操作系统初始化程序(即启动管理器)并执行，完成“开机”的一系列动作。



### 虚拟机
使用虚拟化技术，把一台物理机器虚拟化为多台虚拟机器，每个虚拟机都可以独立运行一个操作系统。
同义术语：虚拟机管理程序/虚拟机监控程序/Virtual Machine Monitor/Hypervisor
第一类VMM，直接运行在硬件上
第二类VMM，运行在宿主操作系统上

### 1.1习题

10.系统调用的目的是请求系统服务，而非申请系统资源


12.文件I/O需要在内核态进行

13.广义指令就是系统调用指令，命令解释器属于命令接口，shell是命令解析器，它也属于命令接口。系统中的缓存全部由操作系统管理，对用户是透明的，操作系统不提供管理系统缓存的系统调用。

### 1.2习题
9.对操作系统的优先级+非抢占式调度算法因素进行改进有利于改善系统的响应时间。
加大时间片会导致系统响应时间增大。
采用静态页式管理：即基本分页存储，进程运行前就将所有页面调入内存
代码可重入：多个进程/线程共享一段代码，执行结果不会相互影响

10.分时操作系统追求的目标是比较快速的响应用户

14.在多道批处理系统出现时，引入了中断技术，使得多道批处理系统的I/O设备可与CPU并行工作

16.多任务操作系统具有并行和并发的特点，并行是指宏观上的并行

### 1.3习题
1.在通用操作系统管理下的计算机上运行程序，依靠系统分配给的时间片，而不需要想操作系统预订运行时间

3.程序设计无法形成程序中断指令

9.从核心态到用户态是由操作系统执行后完成的，而用户态到核心态的转换则是由硬件完成的

11.访管指令仅在用户态下使用。执行访管指令会使用户态转到核心态

12.当CPU执行**操作系统代码**时，处理器处于核心态

15.CPU处于核心态时，它可以执行的访管指令是除“访管”指令外的全部命令

19.中断处理和子程序调用都需要压栈以保护现场，中断处理一定会爆粗呢人子程序调用不需要保存其内容的是程序状态字寄存器

21.trap指令、跳转指令和压栈指令均可以在用户态执行，其中trap指令负责用户态转到内核态。关中断为特权指令，必须在核心态才能执行。在操作系统中，关中断指令是权限非常大的指令，因为中断是现代操作系统正常运行的核心保障之一，能把它关掉说明执行这条指令的一定是权限非常大的机构(管态)。

23.A 可能出现除以0 B 软中断会进入内核态 D可能出现缺页的情况导致中断

26.时钟中断的主要工作是处理和时间有关的信息及决定是否执行调度程序。和时间有关的所有信息包括系统时间、进程的时间片、延时、使用CPU的时间、各种定时器。

27.在执行系统调用的服务程序的过程中，CPU处于内核态
不同的操作系统的底层逻辑和实现方式是不同的，因此为应用程序提供的系统调用接口也是不同的

28.初始化中断向量表是由操作系统完成的

29.trap指令、数据传送指令、设置断点指令都可以在用户态使用，知识可能会导致用户态切换到内核态。而I/O指令只能在内核态下执行

### 1.6习题
4.通常可以从四个方面来描述微内核OS：1.内核足够小 2.基于客户/服务器模式 3.应用“机制与策略分离”原理 4.采用面向对象技术

5.低级I/O和硬件之间紧密相关，因此应该放入微内核

9.计算机操作系统的引导程序位于**硬盘**

10.计算机的启动过程是：1.CPU加电，CS：IP指向FFFF0H 2.执行跳转指令到BIOS 3.等级BIOS中断例程入口地址 4.硬件自检 5.进行操作系统引导

12.真正实现并行的是多核处理机，多台虚拟机同时运行在同一物理机器上，类似于多个程序运行在同一个系统中